CUDA_HOME = /usr/local/cuda
CUDACC = $(CUDA_HOME)/bin/nvcc
CC = gcc
LD = $(CUDACC)

CFLAGS = -c -O3 -g -I$(CUDA_HOME)/include

#SMS ?= 89
# Gencode arguments
#ifeq ($(TARGET_ARCH),$(filter $(TARGET_ARCH),armv7l aarch64 sbsa))
#SMS ?=  70 
#else
#SMS ?=  60 61 70 75
#endif
CUDA_ARCH = $(foreach SM,$(SMS),-gencode arch=compute_$(SM),code=sm_$(SM))

CUDACFLAGS = -c -O3 -lineinfo $(CUDA_ARCH) -Xptxas=-v
LDFLAGS    = -Xcompiler=-fopenmp -lquadmath

C_SRCS  = utils.c
CU_SRCS = main.cu
                                
ifdef USE_MNNVL
$(info Compiling with MNNVL support...)
MPI_HOME = /cm/shared/apps/openmpi/4.1.5

CUDACFLAGS += -I$(MPI_HOME)/include -DUSE_MNNVL
LDFLAGS    += -L$(MPI_HOME)/lib -lcuda -lmpi
CU_SRCS    += vmm_alloc.cu
endif

C_OBJS = $(patsubst %.c, %.o, $(C_SRCS))
CU_OBJS = $(patsubst %.cu, %.o, $(CU_SRCS))

all: cuIsing

cuIsing: $(CU_OBJS) $(C_OBJS)
	$(LD) -o cuIsing $(CU_OBJS) $(C_OBJS) $(LDFLAGS)

%.o: %.cu
	$(CUDACC) $(CUDACFLAGS) $<

%.o: %.c
	$(CC) $(CFLAGS) $< -o $@

clean:
	-@rm -f *.o cuIsing *.sass &> /dev/null || true
