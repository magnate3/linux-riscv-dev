This is the Github repository for 2024 Fall CS243 Final Project: Comparing Collective Communication Algorithms in ASTRA-sim and NS-3

# 1. ASTRA-Sim Setup

Follow the tutorial on [ASTRA-Sim Tutorials - HOTI 2024](https://astra-sim.github.io/tutorials/hoti-2024) to set up ASTRA-Sim and NS-3.

## Step 1: Clone the Repository

Run the following commands to clone the repository and set it up:

```bash
git clone git@github.com:astra-sim/tutorials.git
cd tutorials/hoti2024
git checkout tags/tutorials-hoti2024-ns3
./clone_astra_sim_ns3.sh
```

## Step 2: Download Docker Image and Start a Docker Container

1. Pull the Docker image:

```bash
docker pull astrasim/tutorial-hoti2024:ns3
```

2. Start a Docker container with the cloned ASTRA-Sim attached:

```bash
cd hoti2024
docker run -it \
-v $(pwd):/app/hoti2024 \
astrasim/tutorial-hoti2024:ns3
```

3. Inside the Docker container, navigate to the project directory:

```bash
[docker]$ cd hoti2024
```

## Step 3: Install Chakra Utilities

Install Chakra utilities that come with ASTRA-Sim:

```bash
[docker]$ ./install_chakra.sh
```

## Step 4: Compile ASTRA-Sim

Compile ASTRA-Sim with both analytical and NS-3 network backends:

```bash
[docker]$ ./compile_astra_sim.sh
[docker]$ ./compile_astra_sim_ns3.sh
```

You are now ready to use ASTRA-Sim!


# 2. Collective Algorithm Simulation Parameter Tuning

In each simulation folder, there are the following key files:

- `simulation_folder`
  - `allreduce`
  - `inputs`
    - `Collective_Algo_sys.json`
    - `RemoteMemory.json`
    - `logical_XXnodes_XD.json`
  - `generate_all_reduce.py`
  - `run.sh`

## How to Tune the Parameters

### 1. Collective Algorithm

Modify the `Collective_Algo_sys.json` file. Options can be:
- `"ring"`, `"doubleBinaryTree"`, `"direct"`, `"halvingDoubling"`
- `"direct"` with trailing numbers (`"direct2"`, `"direct3"`, etc.)
- `"oneRing"`, `"oneDirect"`, `"oneHalvingDoubling"`

Example: 2-dim ring-ring

```json
{
    "scheduling-policy": "LIFO",
    "endpoint-delay": 10,
    "active-chunks-per-dimension": 1,
    "preferred-dataset-splits": 4,
    "all-reduce-implementation": ["ring", "ring"],
    "all-gather-implementation": ["ring", "ring"],
    "reduce-scatter-implementation": ["ring", "ring"],
    "all-to-all-implementation": ["ring", "ring"],
    "collective-optimization": "localBWAware",
    "local-mem-bw": 50,
    "boost-mode": 0
}
```

### 2. Topology

- **Physical Topology**
  - The physical topology should be written in `hoti2024/astra-sim/extern/network_backend/ns-3/scratch/topology`.
  - Three predefined example topology files are available [here](https://github.com/astra-sim/astra-network-ns3/tree/a2dd172aa001f61085715e5766c1f566d918b3bb/scratch/topology).

  - Create a physical topology config file in `hoti2024/astra-sim/extern/network_backend/ns-3/scratch/config/`, and update line 6:

    ```text
    TOPOLOGY_FILE ../../scratch/topology/your_topology_file.txt
    ```

- **Logical Topology**
  - The logical topology should match the physical topology.
  - For example, if the physical topology has 128 GPUs, a 2-dim logical topology could be:

    ```json
    {
        "logical-dims": ["16", "8"] 
    }
    ```

    Since `16 * 8 = 128`.

### 3. Message Size

- All-reduce nodes are generated by `generate_all_reduce.py`.
- Adjust lines 20-22 in the Python file for the number of GPUs and message size:

  ```python
  # metadata
  npus_count = 8  # 8 NPUs
  coll_size = 1_048_576  # 1 MB
  ```

- Adjust line 40, ensuring the number of `True` matches the logical dimensions:

  - For 1-dim:
    ```python
    node.attr.append(ChakraAttr(name="involved_dim", bool_list=BoolList(values=[True])))
    ```

  - For 2-dim:
    ```python
    node.attr.append(ChakraAttr(name="involved_dim", bool_list=BoolList(values=[True, True])))
    ```


# 3. Run Collective Algorithm Simulation

## Step 1: Prepare Files

Ensure all the files are prepared as described in the previous steps. Enter the simulation folder.

## Step 2: Generate Allreduce Nodes

Run the following command to generate allreduce nodes:

```bash
python3 generate_all_reduce.py
```

## Step 3: Adjust `run.sh`

Modify the `run.sh` script to include the correct configurations for:
- Workload Configuration
- System Configuration
- Logical Topology Configuration
- Network Configuration

Example `run.sh`:

```bash
# Run ASTRA-sim
(
cd ${ASTRA_SIM_BUILD_DIR}
${ASTRA_SIM} \
    --workload-configuration=${SCRIPT_DIR}/allreduce/allreduce \
    --system-configuration=${SCRIPT_DIR}/inputs/Collective_Algo_sys.json \
    --remote-memory-configuration=${SCRIPT_DIR}/inputs/RemoteMemory.json \
    --logical-topology-configuration=${SCRIPT_DIR}/inputs/logical_128nodes_1D.json \
    --network-configuration=../../../ns-3/scratch/config/config_128_nodes_16_switch_topology.txt \
    --comm-group-configuration="empty"
)
```

## Step 4: Run `run.sh`

Execute the `run.sh` script:

```bash
./run.sh
```

## Example Output

The output of an 8-node 2-dimension simulation should look like this:

```plaintext
root@d627a9632691:/app/hoti2024/demo_run# ./run.sh
ASTRA-sim + NS3
There are 8 npus: 2,4,
QP is enabled 
maxRtt=2040 maxBdp=102000
sys[6] finished, 3856445 cycles
sys[7] finished, 4078679 cycles
sys[2] finished, 5148190 cycles
sys[0] finished, 5370402 cycles
sys[4] finished, 5370418 cycles
sys[3] finished, 5370424 cycles
sys[1] finished, 5592636 cycles
sys[5] finished, 5592652 cycles
```

# 4. Change Congestion Control Algorithm

The config files about ns-3 are stored in `hoti2024/astra-sim/extern/network_backend/ns-3/scratch/config/`. Find the config you are using and modify `CC_MODE`.

```
CC_MODE 3 {Specifying different CC. 1: DCQCN, 3: HPCC, 7: TIMELY, 8: DCTCP, 10: HPCC-PINT, 12: None}
```

